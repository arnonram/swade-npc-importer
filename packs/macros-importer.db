{"_id":"gPdUf80lOKAE8WR7","name":"NPC Importer - Fix Active Effects","type":"script","author":"8mset5bYo0Q1JQxx","img":"icons/svg/upgrade.svg","scope":"global","command":"// SWADE Stat Block Importer Macro\n// This macro is here in order to retro-fix imported characters due to a bug in version 0.1.14\n// In that version, Items with effect would have been imported incorrectly, and this macro runs on the NPCs and fixes it\n// If you want this macro to run on all characters, then change then change the first line of code to => `const allActors = game.actors`\n\n// !!!! IMPORTANT: !!!!!\n// This will go over ALL Actors in a world. I strongly recommend that you backup the World or your Actors somehow before running the fix macro.\n// For any Actor which has an `effects` fields to fix, then it will delete the Actor and create a new one. !!! IMPORTANT !!!: this might remove certain links on the affected Actor due to ID change)\n\n\nconst allActors = game.actors.filter(a => a.data.type == 'npc');\nlet toUpdate = false;\n\nfor (const actor of allActors) {\n  toUpdate = false;\n  const actorToUpdate = removeEffects(actor.toObject());\n  if (toUpdate) {\n    console.log(`updating actor: ${actor.name()}`);\n    await actor.delete();\n    await Actor.create(actorToUpdate);\n  }\n}\n\nfunction removeEffects(data) {\n  for (var property in data) {\n    if (typeof data[property] == 'object') {\n      delete data.property;\n      let newJsonData = removeEffects(data[property], 'effects');\n      data[property] = newJsonData;\n    } else {\n      if (property === 'effects' && typeof data[property] === 'string') {\n        data[property] = JSON.parse(data[property]);\n        toUpdate = true;\n      }\n    }\n  }\n  return data;\n}","folder":null,"sort":0,"permission":{"default":0,"8mset5bYo0Q1JQxx":3},"flags":{"core":{"sourceId":"Macro.OTgxLaNUkbS0oPN3"}}}
